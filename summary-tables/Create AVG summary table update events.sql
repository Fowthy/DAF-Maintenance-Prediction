-- Drop events if they exist
DROP EVENT IF EXISTS update_avg_summary_a11_a1;
DROP EVENT IF EXISTS update_avg_summary_a2_z;
DROP EVENT IF EXISTS update_avg_summary_w_q1;
DROP EVENT IF EXISTS update_avg_summary_c_b;
DROP EVENT IF EXISTS update_avg_summary_x_y;

-- Create avg summary tables update events

CREATE EVENT update_avg_summary_a11_a1
ON SCHEDULE
    EVERY 1 MINUTE
DO
	INSERT INTO AVG_SUMMARY_A11_A1 (BFC_TIMESTAMP, BFC_SOURCE_ID, DATAPOINT_A11_Speed, DATAPOINT_A11_Position, DATAPOINT_A11_Current, DATAPOINT_A11_Torque, DATAPOINT_A11_DevPos, DATAPOINT_A1_Speed, DATAPOINT_A1_Position, DATAPOINT_A1_Current, DATAPOINT_A1_Torque)
	SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(BFC_TIMESTAMP) DIV 60 * 60) AS time,
		BFC_SOURCE_ID,
		AVG(DATAPOINT_A11_Speed),
		AVG(DATAPOINT_A11_Position),
		AVG(DATAPOINT_A11_Current),
		AVG(DATAPOINT_A11_Torque),
		AVG(DATAPOINT_A11_DevPos),
		AVG(DATAPOINT_A1_Speed),
		AVG(DATAPOINT_A1_Position),
		AVG(DATAPOINT_A1_Current),
		AVG(DATAPOINT_A1_Torque)
	FROM dataset_a11_axis_a1_axis
  WHERE BFC_TIMESTAMP >= (select max(BFC_TIMESTAMP) from AVG_SUMMARY_A11_A1)
	GROUP BY time, BFC_SOURCE_ID
	ORDER BY time
	ON DUPLICATE KEY UPDATE
		DATAPOINT_A11_Speed = VALUES(DATAPOINT_A11_Speed),
		DATAPOINT_A11_Position = VALUES(DATAPOINT_A11_Position),
		DATAPOINT_A11_Current = VALUES(DATAPOINT_A11_Current),
		DATAPOINT_A11_Torque = VALUES(DATAPOINT_A11_Torque),
		DATAPOINT_A11_DevPos = VALUES(DATAPOINT_A11_DevPos),
		DATAPOINT_A1_Speed = VALUES(DATAPOINT_A1_Speed),
		DATAPOINT_A1_Position = VALUES(DATAPOINT_A1_Position),
		DATAPOINT_A1_Current = VALUES(DATAPOINT_A1_Current),
		DATAPOINT_A1_Torque = VALUES(DATAPOINT_A1_Torque);

-- ////////////////////////////////////////////////////////////////////////////////////

CREATE EVENT update_avg_summary_a2_z
ON SCHEDULE 
	EVERY 1 MINUTE
DO
	INSERT INTO AVG_SUMMARY_A2_Z (BFC_TIMESTAMP, BFC_SOURCE_ID, DATAPOINT_A2_Speed, DATAPOINT_A2_Position, DATAPOINT_A2_Current, DATAPOINT_A2_Torque, DATAPOINT_A2_PosDev, DATAPOINT_Z_Speed, DATAPOINT_Z_Position, DATAPOINT_Z_Current, DATAPOINT_Z_Torque, DATAPOINT_Z_PosDev, DATAPOINT_Z_Lag, DATAPOINT_Z_ControlDev, DATAPOINT_Z_ContourDev)
		SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(BFC_TIMESTAMP) DIV 60 * 60) AS time,
		BFC_SOURCE_ID,
		AVG(DATAPOINT_A2_Speed),
		AVG(DATAPOINT_A2_Position),
		AVG(DATAPOINT_A2_Current),
		AVG(DATAPOINT_A2_Torque),
		AVG(DATAPOINT_A2_PosDev),
		AVG(DATAPOINT_Z_Speed),
		AVG(DATAPOINT_Z_Position),
		AVG(DATAPOINT_Z_Current),
		AVG(DATAPOINT_Z_Torque),
		AVG(DATAPOINT_Z_PosDev),
		AVG(DATAPOINT_Z_Lag),
		AVG(DATAPOINT_Z_ControlDev),
		AVG(DATAPOINT_Z_ContourDev)
	FROM DATASET_A2_Axis_Z_Axis
    WHERE BFC_TIMESTAMP >= (select max(BFC_TIMESTAMP) from AVG_SUMMARY_A2_Z)
    GROUP BY time, BFC_SOURCE_ID
    ORDER BY time
    ON DUPLICATE KEY UPDATE
		DATAPOINT_A2_Speed = VALUES(DATAPOINT_A2_Speed),
		DATAPOINT_A2_Position = VALUES(DATAPOINT_A2_Position),
		DATAPOINT_A2_Current = VALUES(DATAPOINT_A2_Current),
		DATAPOINT_A2_Torque = VALUES(DATAPOINT_A2_Torque),
		DATAPOINT_A2_PosDev = VALUES(DATAPOINT_A2_PosDev),
		DATAPOINT_Z_Speed = VALUES(DATAPOINT_Z_Speed),
		DATAPOINT_Z_Position = VALUES(DATAPOINT_Z_Position),
		DATAPOINT_Z_Current = VALUES(DATAPOINT_Z_Current),
		DATAPOINT_Z_Torque = VALUES(DATAPOINT_Z_Torque),
		DATAPOINT_Z_PosDev = VALUES(DATAPOINT_Z_PosDev),
		DATAPOINT_Z_Lag = VALUES(DATAPOINT_Z_Lag),
		DATAPOINT_Z_ControlDev = VALUES(DATAPOINT_Z_ControlDev),
		DATAPOINT_Z_ContourDev = VALUES(DATAPOINT_Z_ContourDev);

-- ////////////////////////////////////////////////////////////////////////////////////

CREATE EVENT update_avg_summary_w_q1
ON SCHEDULE 
	EVERY 1 MINUTE
DO
	INSERT INTO AVG_SUMMARY_W_Q1 (BFC_TIMESTAMP, BFC_SOURCE_ID, DATAPOINT_W_Speed, DATAPOINT_W_Position, DATAPOINT_W_Current, DATAPOINT_W_Torque, DATAPOINT_W_PosDev, DATAPOINT_Q1_Speed, DATAPOINT_Q1_Position, DATAPOINT_Q1_Current, DATAPOINT_Q1_Torque, DATAPOINT_Q1_PosDev)
		SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(BFC_TIMESTAMP) DIV 60 * 60) AS time,
		BFC_SOURCE_ID,
		AVG(DATAPOINT_W_Speed),
		AVG(DATAPOINT_W_Position),
		AVG(DATAPOINT_W_Current),
		AVG(DATAPOINT_W_Torque),
		AVG(DATAPOINT_W_PosDev),
		AVG(DATAPOINT_Q1_Speed),
		AVG(DATAPOINT_Q1_Position),
		AVG(DATAPOINT_Q1_Current),
		AVG(DATAPOINT_Q1_Torque),
		AVG(DATAPOINT_Q1_PosDev)
	FROM DATASET_W_Axis_Q1_Axis
  WHERE BFC_TIMESTAMP >= (select max(BFC_TIMESTAMP) from AVG_SUMMARY_W_Q1)
	GROUP BY time, BFC_SOURCE_ID
	ORDER BY time
    ON DUPLICATE KEY UPDATE
		DATAPOINT_W_Speed = VALUES(DATAPOINT_W_Speed),
		DATAPOINT_W_Position = VALUES(DATAPOINT_W_Position),
		DATAPOINT_W_Current = VALUES(DATAPOINT_W_Current),
		DATAPOINT_W_Torque = VALUES(DATAPOINT_W_Torque),
		DATAPOINT_W_PosDev = VALUES(DATAPOINT_W_PosDev),
		DATAPOINT_Q1_Speed = VALUES(DATAPOINT_Q1_Speed),
		DATAPOINT_Q1_Position = VALUES(DATAPOINT_Q1_Position),
		DATAPOINT_Q1_Current = VALUES(DATAPOINT_Q1_Current),
		DATAPOINT_Q1_Torque = VALUES(DATAPOINT_Q1_Torque),
		DATAPOINT_Q1_PosDev = VALUES(DATAPOINT_Q1_PosDev);

-- ////////////////////////////////////////////////////////////////////////////////////

CREATE EVENT update_avg_summary_c_b
ON SCHEDULE 
	EVERY 1 MINUTE
DO
	INSERT INTO AVG_SUMMARY_C_B (BFC_TIMESTAMP, BFC_SOURCE_ID, DATAPOINT_C_Speed, DATAPOINT_C_Position, DATAPOINT_C_Current, DATAPOINT_C_Torque, DATAPOINT_B_Speed, DATAPOINT_B_Position, DATAPOINT_B_Current, DATAPOINT_B_Torque, DATAPOINT_B_PosDev)
		SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(BFC_TIMESTAMP) DIV 60 * 60) AS time,
		BFC_SOURCE_ID,
		AVG(DATAPOINT_C_Speed),
		AVG(DATAPOINT_C_Position),
		AVG(DATAPOINT_C_Current),
		AVG(DATAPOINT_C_Torque),
		AVG(DATAPOINT_B_Speed),
		AVG(DATAPOINT_B_Position),
		AVG(DATAPOINT_B_Current),
		AVG(DATAPOINT_B_Torque),
		AVG(DATAPOINT_B_PosDev)
	FROM DATASET_C_Axis_B_Axis
  WHERE BFC_TIMESTAMP >= (select max(BFC_TIMESTAMP) from AVG_SUMMARY_C_B)
	GROUP BY time, BFC_SOURCE_ID
	ORDER BY time
    ON DUPLICATE KEY UPDATE
		DATAPOINT_C_Speed = VALUES(DATAPOINT_C_Speed),
		DATAPOINT_C_Position = VALUES(DATAPOINT_C_Position),
		DATAPOINT_C_Current = VALUES(DATAPOINT_C_Current),
		DATAPOINT_C_Torque = VALUES(DATAPOINT_C_Torque),
		DATAPOINT_B_Speed = VALUES(DATAPOINT_B_Speed),
		DATAPOINT_B_Position = VALUES(DATAPOINT_B_Position),
		DATAPOINT_B_Position = VALUES(DATAPOINT_Q1_Position),
		DATAPOINT_B_Current = VALUES(DATAPOINT_B_Current),
		DATAPOINT_B_Torque = VALUES(DATAPOINT_B_Torque),
		DATAPOINT_B_PosDev = VALUES(DATAPOINT_B_PosDev);

-- ////////////////////////////////////////////////////////////////////////////////////

CREATE EVENT update_avg_summary_x_y
ON SCHEDULE 
	EVERY 1 MINUTE
DO
	INSERT INTO AVG_SUMMARY_X_Y (BFC_TIMESTAMP, BFC_SOURCE_ID, DATAPOINT_X_Speed, DATAPOINT_X_Position, DATAPOINT_X_Current, DATAPOINT_X_Torque, DATAPOINT_X_PosDev, DATAPOINT_X_Lag, DATAPOINT_X_ControlDev, DATAPOINT_X_DontourDev, DATAPOINT_Y_Speed, DATAPOINT_Y_Position, DATAPOINT_Y_Current, DATAPOINT_Y_Torque, DATAPOINT_Y_PosDev)
		SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(BFC_TIMESTAMP) DIV 60 * 60) AS time,
		BFC_SOURCE_ID,
		AVG(DATAPOINT_X_Speed),
		AVG(DATAPOINT_X_Position),
		AVG(DATAPOINT_X_Current),
		AVG(DATAPOINT_X_Torque),
		AVG(DATAPOINT_X_PosDev),
		AVG(DATAPOINT_X_Lag),
		AVG(DATAPOINT_X_ControlDev),
		AVG(DATAPOINT_X_ContourDev),
		AVG(DATAPOINT_Y_Speed),
		AVG(DATAPOINT_Y_Position),
		AVG(DATAPOINT_Y_Current),
		AVG(DATAPOINT_Y_Torque),
		AVG(DATAPOINT_Y_PosDev)
	FROM DATASET_X_Axis_Y_Axis
  WHERE BFC_TIMESTAMP >= (select max(BFC_TIMESTAMP) from AVG_SUMMARY_X_Y)
	GROUP BY time, BFC_SOURCE_ID
	ORDER BY time
	ON DUPLICATE KEY UPDATE
		DATAPOINT_X_Speed = VALUES(DATAPOINT_X_Speed),
		DATAPOINT_X_Position = VALUES(DATAPOINT_X_Position),
		DATAPOINT_X_Current = VALUES(DATAPOINT_X_Current),
		DATAPOINT_X_Torque = VALUES(DATAPOINT_X_Torque),
		DATAPOINT_X_PosDev = VALUES(DATAPOINT_X_PosDev),
		DATAPOINT_X_Lag = VALUES(DATAPOINT_X_Lag),
		DATAPOINT_X_ControlDev = VALUES(DATAPOINT_X_ControlDev),
		DATAPOINT_X_ContourDev = VALUES(DATAPOINT_X_ContourDev),
		DATAPOINT_Y_Speed = VALUES(DATAPOINT_Y_Speed),
		DATAPOINT_Y_Position = VALUES(DATAPOINT_Y_Position),
		DATAPOINT_Y_Current = VALUES(DATAPOINT_Y_Current),
		DATAPOINT_Y_Torque = VALUES(DATAPOINT_Y_Torque),
		DATAPOINT_Y_PosDev = VALUES(DATAPOINT_Y_PosDev);

-- ////////////////////////////////////////////////////////////////////////////////////

-- disable events
ALTER EVENT update_avg_summary_a2_z
disable;

ALTER EVENT update_avg_summary_a11_a1
disable;

ALTER EVENT update_avg_summary_c_b
disable;

ALTER EVENT update_avg_summary_w_q1
disable;

ALTER EVENT update_avg_summary_x_y
disable;

-- show all events
show events;